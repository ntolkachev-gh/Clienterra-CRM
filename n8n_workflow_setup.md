# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ n8n Workflow —Å API Endpoint

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
Telegram Bot ‚Üí n8n Webhook ‚Üí HTTP Request ‚Üí Flask API ‚Üí PostgreSQL
```

## 1. –°–æ–∑–¥–∞–Ω–∏–µ n8n Workflow

### –®–∞–≥ 1: Webhook Node
- **Node Type**: Webhook
- **HTTP Method**: POST
- **Path**: `text-from-user`
- **Response Mode**: Last Node

### –®–∞–≥ 2: HTTP Request Node (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É)
- **Node Type**: HTTP Request
- **Method**: POST
- **URL**: `https://clienterra-crm.herokuapp.com/api/save_final_message`
- **Headers**: 
  ```
  Content-Type: application/json
  ```
- **Body**: JSON
  ```json
  {
    "user": {
      "telegram_id": "{{ $json.user.telegram_id }}",
      "first_name": "{{ $json.user.first_name }}",
      "last_name": "{{ $json.user.last_name }}",
      "username": "{{ $json.user.username }}",
      "language_code": "{{ $json.user.language_code }}"
    },
    "message": {
      "text": "{{ $json.message.text }}",
      "message_type": "{{ $json.message.message_type }}",
      "timestamp": "{{ $json.message.timestamp }}",
      "message_id": "{{ $json.message.message_id }}"
    },
    "metadata": {
      "is_first_message": "{{ $json.metadata.is_first_message }}",
      "chat_id": "{{ $json.metadata.chat_id }}"
    }
  }
  ```

### –®–∞–≥ 3: Telegram Node (–¥–ª—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
- **Node Type**: Telegram
- **Operation**: Send Message
- **Chat ID**: `{{ $json.metadata.chat_id }}`
- **Text**: –í–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ—Ç–≤–µ—Ç

## 2. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –î–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:
1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `user_brief` –∫–ª–∏–µ–Ω—Ç–∞ (—Å—ã—Ä–æ–π –±—Ä–∏—Ñ)
2. –°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–≤ —Ä–∞–±–æ—Ç–µ"
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç

### –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `messages`
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç

## 3. –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤

### –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
```
–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞! üéØ

–Ø –ø–æ–Ω—è–ª, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ: {{ $json.message.text }}

–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.

–ê –ø–æ–∫–∞ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ:
‚Ä¢ –ö–∞–∫–æ–π —É –≤–∞—Å –±—é–¥–∂–µ—Ç?
‚Ä¢ –ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∑–∞–ø—É—Å–∫?
‚Ä¢ –ï—Å—Ç—å –ª–∏ –æ—Å–æ–±—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?
```

### –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
```
–ü–æ–Ω—è–ª! üìù –°–æ—Ö—Ä–∞–Ω–∏–ª –≤–∞—à—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –ø—Ä–æ–µ–∫—Ç–µ, –∞ —è —Å–æ–±–µ—Ä—É –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –Ω–∞—à–∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.
```

## 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
```bash
chmod +x test_final_message_api.sh
./test_final_message_api.sh
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
- –û—Ç–∫—Ä–æ–π—Ç–µ `https://clienterra-crm.herokuapp.com`
- –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤

## 5. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–π –±–∞–∑–µ
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤** - –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è—Ç—å
‚úÖ **–ì–∏–±–∫–∞—è –ª–æ–≥–∏–∫–∞** - –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** - –æ–¥–∏–Ω HTTP –∑–∞–ø—Ä–æ—Å
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è

## 6. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ

### –¢–∞–±–ª–∏—Ü–∞ `client`:
- `telegram_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `name` - –ø–æ–ª–Ω–æ–µ –∏–º—è
- `user_brief` - —Å—ã—Ä–æ–π –±—Ä–∏—Ñ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- `project_description` - –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
- `status` - —Å—Ç–∞—Ç—É—Å (–Ω–æ–≤—ã–π ‚Üí –≤ —Ä–∞–±–æ—Ç–µ ‚Üí –∑–∞–≤–µ—Ä—à—ë–Ω)

### –¢–∞–±–ª–∏—Ü–∞ `message`:
- `client_id` - —Å–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º
- `message_text` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- `is_from_bot` - –æ—Ç –±–æ—Ç–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `timestamp` - –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ 